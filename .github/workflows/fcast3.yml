on:
  schedule:
  - cron: '34 3,4,5,6,9,12 * * *'

  workflow_dispatch:

jobs:
  fcast3:
    runs-on: ubuntu-latest
    outputs:
      json: ${{ steps.fcast.outputs.json }}
      xml: ${{ steps.fcast.outputs.xml }}
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v2

    - name: Install Dependencies
      run: npm install --no-save

    - name: Fetch Forecast
      id: fcast
      uses: ./.github/actions/fcast

  deploy:
    if: success() && github.ref == 'refs/heads/main'
    needs: fcast3
    runs-on: ubuntu-latest
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v2
      with:
        ref: gh-pages

    - name: Prepare for Release
      env:
        JSON: ${{ needs.fcast3.outputs.json }}
        XML: ${{ needs.fcast3.outputs.xml }}
      run: |
        rm -f CNAME
        echo "$JSON" > ./fcast3.json
        echo "$XML" > ./fcast3.xml
        test -f ./fcast3.json
        test -f ./fcast3.xml

    - name: Deploy to Github Pages
      uses: crazy-max/ghaction-github-pages@v2
      with:
        author: Dusan Vuckovic <dusan@dvuckovic.com>
        commit_message: Deployed to Github Pages.
        fqdn: data.dvuckovic.com
        build_dir: .
        repo: dvuckovic/data-miner
        target_branch: gh-pages
      env:
        GITHUB_TOKEN: ${{ secrets.GH_PAT }}
